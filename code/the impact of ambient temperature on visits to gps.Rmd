---
title: "Impact of Ambient Temperature on Visits to General Practitioners"
author: "Raphael Kroes"
date: "2023-12-02"
output: html_document
---

This is the main Markdown file for the data analysis of 'Impact of Ambient Temperature on Visits to General Practitioners' by Raphael Kroes.
The original data cannot be provided publicly because of data protection reasons. However, an algorithm to create a fake dataset is provided, which can be used to test the code.
```{r}
library(devtools)
library(readxl)
library(lubridate)
library(dplyr)
library(parallel)
library(lightgbm)
library(VGAM)
library(Matrix)
library(tictoc)
```
```{r}


#read file with functions
source("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/code/functions_mt.R")

#read auxiliary data files
ListeKrankenkassen<- read.csv("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/other%20data/ListeKrankenkassen_up.csv")
classification.matrix<- read.csv("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/other%20data/classification.csv")
icd10_blocks<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/icd10_blocks.csv")
holidays<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/numeric_holidays.csv")

fake.data<- TRUE
if(fake.data){
  source_url("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/code/fakedgp_mt.R")
}else{
  old.wd<- getwd()
  setwd("N:/StudentischeHilfskraefte/_Kroes (Christoph)/Routinedaten/01_Husten/R/DB")
  names.vec<- c("Diag3", "Stamm3", "Konsul3")
  for (i in seq(1,length(names.vec))){
    file.name<- paste0("DB_", names.vec[i], "_v03", ".csv")
    im.file<- read.csv(file = file.name, header = TRUE, sep = ";")
    assign(names.vec[i], im.file)
  }
  rm(file.name, im.file)
  setwd(old.wd)
}

#date range
date.range<- range(Diag3$TG_DateNum)

#location data
location_information<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/location%20information.csv", header = TRUE, encoding = "Latin-1")
location.name<- location_information$location.name

#weather data
for(i in seq_along(location.name)){
  url_string<- paste0("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/weather%20data/weather_", location.name[i], ".csv")
  im<- read.csv(url_string)
  colnames(im)<- c("time", "temperature_celsius", "relative_humidity", 
                   "dew_point", "apparent_temperature_celsius", "precipitation", 
                   "rain", "snow_fall", "snow_depth", "surface_pressure")

  #unit transformations
  im$TG_DateNum<- date2TG_DateNum(im$time)
  im<- im|>
    filter(TG_DateNum>=date.range[1]-21 & TG_DateNum<=date.range[2])
  im$temperature_kelvin<- im$temperature_celsius +273.16
  
  weatherdata.transformation(im, sel.quantile = .95, loc = location.name[i], 
                             dr = date.range)
  #assign(paste0("wetter_",location.name[i]),im)
}



#daylight data
for(i in seq_along(location.name)){
  url_string<- paste0("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/daylight%20hours%20data/daylight_", location.name[i], ".csv")
  im<- read.csv(url_string, header = TRUE)
  
  #unit transformations
  #im$TG_DateNum<- date2TG_DateNum(im$time)
  im<- im|>
    filter(TG_DateNum >= date.range[1] & TG_DateNum <= date.range[2])
  assign(paste0("daylight_", location.name[i]), im)
}

#Covid-19 data
covid.data<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/COVID-19-Faelle_7-Tage-Inzidenz_Landkreise.csv")
covid.data<- covid.data|>
  filter(Landkreis_id %in% location_information$landkreis_id)
covid.data$TG_DateNum<- date2TG_DateNum(covid.data$Meldedatum)





```
We must check Diag's icd10 column: Since the icd10 field is a text field in the GP's software, the data might contain typing errors or atypical notation of diseases. This function returns a vector that filters out whose entries are =1 if they are 'suspicious' and 0 otherwise. An entry is considered suspicious if it does not have a length of 4, 6, or 7 characters. If it has 4, 6, or 7 characters it is suspicious if it does not follow either of the patterns "capital letter, two numbers, capital letter" or "capital letter, two numbers, fullstop, one or two numbers, capital letter".
```{r}
View(Diag3[as.logical(suspicious.Diag.entries(Diag3$icd10)),])
```

Merging and transformation process, using Diag as baseline:
1. Filter out chronic diseases and add them as patient specific variables
2. Merge Stamm data, create new gender dummy, add dummy for private or public health insurance provider, add county (Landkreis; for convenience)
3. Merge Konsul data (and remove duplicate columns)
4. Create time variables from the date
5. Merge Covid-19 incidence values, also add dummy variable for incidence larger than zero
6. Create risk factors variables
```{r}
### save workspace image regularily?
make.saves<- FALSE

### acute and chronic diseases, last visit
chronic.sel<- grepl("DD",Diag3$DiagTyp)
chronic.df<- data.frame(uniPatID = Diag3$uniPatID[chronic.sel], 
                        diag_category = Diag3$icd10[chronic.sel])|>
  distinct()
chronic.df$diag_category<- icd10.to.class(chronic.df$diag_category)
full.df_1<- add.chronic(Diag3[!chronic.sel,], chronic.df)
full.df_1$diag_class<- icd10.to.class(full.df_1$icd10)
full.df_1.1<- add.last.visit(full.df_1, no.splits = 50, no.workers = 4)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### stamm data
full.df_1.2<- add.stamm.new.par(full.df_1.1, Stamm3, no.splits = 50, 
                                no.workers = 4)
# gender variable
gender.selector<- full.df_1.2$Weibl==1 | full.df_1.2$Maennl==1 | 
  full.df_1.2$stamm.is.there==0
full.df_1.2$female<- full.df_1.2$Weibl
full.df_1.3<- full.df_1.2[gender.selector,]|>
  select(-Weibl, -Maennl, -Transgen, -Divers, -Geschlundef)
#add PKV (private health insurance) dummy
full.df_1.3$PKV[full.df_1.3$stamm.is.there == 1]<- IK2PKV(
  full.df_1.3$IK[full.df_1.3$stamm.is.there==1])
#add Landkreis_id
full.df_1.3$landkreis<- praxisID2location(full.df_1.3$PraxisID)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### konsul
full.df_2<- add.konsul(full.df_1.3, Konsul3, no.splits = 50, no.workers = 4)
col.selector<- !duplicated(colnames(full.df_2))
full.df_2.2<- full.df_2[,col.selector]
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### time
full.df_3<- full.df_2.2
full.df_3$dow<- as.factor(TG_DateNum2dow(full.df_3$TG_DateNum))
full.df_3<- cbind(full.df_3,TG_DateNum2holiday(full.df_3$TG_DateNum))
full.df_3$week<- as.factor(TG_DateNum2week(full.df_3$TG_DateNum))
full.df_3$week_of_month<- TG_DateNum2week.of.month(full.df_3$TG_DateNum)
full.df_3$month<- as.factor(TG_DateNum2month(full.df_3$TG_DateNum))
full.df_3$year<- as.factor(TG_DateNum2year(full.df_3$TG_DateNum))
full.df_3$age<- TG_DateNum2year(full.df_3$TG_DateNum) - full.df_3$Geburtsjahr
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### covid-19
full.df_4<- full.df_3
full.df_4$Landkreis_id<- praxis_id2landkreis_id(full.df_4$PraxisID)
full.df_4<- full.df_4|>
  arrange(Landkreis_id,TG_DateNum)
full.df_4.2<- add.covid(full.df_4,covid.data, no.workers = 4)
full.df_4.2$covid_positive_incidence<- full.df_4.2$covid_7_day_incidence > 0
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### risk factors
full.df_5<- full.df_4.2
full.df_5$smoking<- risk.factor.merger(full.df_5$TG_A_Rauchen,
                                       full.df_5$TG_RF_Rauchen)
full.df_5$alcohol<- risk.factor.merger(full.df_5$TG_A_Alkohol,
                                       full.df_5$TG_RF_Alkohol)
full.df_5$sport<- risk.factor.merger(full.df_5$TG_A_Sport,
                                     full.df_5$TG_RF_Sport)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

### add weather variables
full.df_6<- full.df_5
full.df_6<- add.weather(full.df_6, no.workers = 4)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

###add daylight data
full.df_7<- full.df_6
full.df_7<- add.daylight(full.df_6, no.workers = 4)|>
  arrange(TG_DateNum)
if(make.saves){
  save.image(file = paste0("ws_",as.character(as.Date(Sys.time(), format = "%Y_%m_%d")),".RData"))
  write.csv2(full.df_7, file = "final_df.csv", row.names = FALSE)
}
```
Table 1 (descriptive statistics):
```{r}
table_1<- data.frame(Metric = c("Total number of patients",
                                "First date",
                                "Last date",
                                "Total number of observations",
                                "Number of chronically diseased patients",#5
                                "Percentage chronically diseased patients",
                                "Number of practices",
                                "Age of the youngest patient",
                                "Age of oldest patient",
                                "Median patient age",#10
                                "Percentage directly cold related injuries",
                                "Percentage injuries due to excessive heat",
                                "Percentage major cardiovascular disease",
                                "Percentage external causes of morbidity",
                                "Percentag mental and behavioural disorders",#15
                                "Percentage diseases of the respiratory system",
                                "Percentage endocrine, nutritional, and metabolic disorders",
                                "Percentage diseases of the digestive system",
                                "Percentage genitourinary disorders",
                                "Percentage musculoskeletal disorders",#20
                                "Percentage other diseases and injuries",
                                "Number of privately insured individuals",
                                "Number of not privately insured individuals",
                                "Percentage of privately insured individuals",
                                "Percentage of not privately insured individuals",#25
                                "Number of incidents by privately insured individuals",
                                "Number of incidents by not privately insured individuals",
                                "Percentage of incidents by privately insured individuals",
                                "Percentage of incidents by not privately insured individuals",
                                "Number of retired patients",#30
                                "Percentage of retired patients",
                                "Number of incidents of retired patients",
                                "Percentage of incidents of retired patients",
                                "Percentage self-recorded smokers",
                                "Percentage self-recorded alcohol consumer",#35
                                "Percentage self-recorded participation in sports"
                                ),
                     Value = c(length(unique(full.df_7$uniPatID)),
                               TG_DateNum2date(min(full.df_7$TG_DateNum)),
                               TG_DateNum2date(max(full.df_7$TG_DateNum)),
                               nrow(full.df_7),
                               length(unique(chronic.df$uniPatID)),#5
                               length(unique(chronic.df$uniPatID)) / length(unique(full.df_7$uniPatID)),
                               length(unique(full.df_7$PraxisID)),
                               min(full.df_7$age, na.rm = TRUE),
                               max(full.df_7$age, na.rm = TRUE),
                               median(full.df_7$age, na.rm = TRUE),#10
                               mean(full.df_7$diag_class==1),
                               mean(full.df_7$diag_class==2),
                               mean(full.df_7$diag_class==3),
                               mean(full.df_7$diag_class==4),
                               mean(full.df_7$diag_class==5),#15
                               mean(full.df_7$diag_class==6),
                               mean(full.df_7$diag_class==7),
                               mean(full.df_7$diag_class==8),
                               mean(full.df_7$diag_class==9),
                               mean(full.df_7$diag_class==10),#20
                               mean(full.df_7$diag_class==11),
                               length(unique(full.df_7$uniPatID[full.df_7$PKV==1])),
                               length(unique(full.df_7$uniPatID[full.df_7$PKV==0])),
                               length(unique(full.df_7$uniPatID[full.df_7$PKV==1])) / length(unique(full.df_7$uniPatID)),
                               length(unique(full.df_7$uniPatID[full.df_7$PKV==0])) / length(unique(full.df_7$uniPatID)),#25
                               length((full.df_7$uniPatID[full.df_7$PKV==1])),
                               length((full.df_7$uniPatID[full.df_7$PKV==0])),
                               length((full.df_7$uniPatID[full.df_7$PKV==1])) / length((full.df_7$uniPatID)),
                               length((full.df_7$uniPatID[full.df_7$PKV==0])) / length((full.df_7$uniPatID)),
                               length(unique(full.df_7$uniPatID[full.df_7$Status_R==1])),#30
                               length(unique(full.df_7$uniPatID[full.df_7$Status_R==1])) / length(unique(full.df_7$uniPatID)),
                               sum(full.df_7$Status_R, na.rm = TRUE),
                               mean(full.df_7$Status_R, na.rm = TRUE),
                               mean(full.df_7$smoking[!duplicated(full.df_7$uniPatID)], na.rm = TRUE),
                               mean(full.df_7$alcohol[!duplicated(full.df_7$uniPatID)], na.rm = TRUE),#35
                               mean(full.df_7$sport[!duplicated(full.df_7$uniPatID)], na.rm = TRUE)
                               ))
write.table(table_1, file = "table_1.csv", sep = "; ", row.names = FALSE)

```
Research Question 1:
```{r}
#Hyperparameter tuning
hyperpars_age<- genetic.algorithm(optim.seed = 4567, n = 50, 
                                    pcrossover = 0.8, pmutation = 0.1, 
                                    maxiter = 3, elitism = 4, digits = c(2,3,3),
                                    sdi = TRUE, lr = c(0,1), 
                                    no.leaves = c(2,40), max.depth = c(1,10),
                                    min.data.in.leaf = c(2,1e7), 
                                    feature.fraction = c(0,1), cat.l2 = c(0,99),
                                    extra.trees = c(0,1), top.rate = c(0,0.5),
                                    other.rate = c(0,0.5), cat.smooth = c(0,99),
                                    path.smooth = c(0,99),
                                    inputdf = df_qx(di = "SDI", q = 1),
                                    y = full.df_7$age, est_type = "quantile",
                                    alpha = 0.5, cv = 2L, no_trees = 100L,
                                    no_threads = 4L, early_stopping = 10L)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))
#add a later increase in number of significant digits

hyperpars_gender<- genetic.algorithm(optim.seed = 4567, n = 50, 
                                    pcrossover = 0.8, pmutation = 0.1, 
                                    maxiter = 3, elitism = 4, digits = c(2,3,3),
                                    sdi = TRUE, lr = c(0,1), 
                                    no.leaves = c(2,40), max.depth = c(1,10),
                                    min.data.in.leaf = c(2,1e7), 
                                    feature.fraction = c(0,1), cat.l2 = c(0,99),
                                    extra.trees = c(0,1), top.rate = c(0,0.5),
                                    other.rate = c(0,0.5), cat.smooth = c(0,99),
                                    path.smooth = c(0,99),
                                    inputdf = df_qx(di = "SDI", q = 1),
                                    y = full.df_7$female, 
                                    est_type = "cross_entropy", alpha = 0.5, 
                                    cv = 2L, no_trees = 100L, no_threads = 4L, 
                                    early_stopping = 10L)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

hyperpars_phi<- genetic.algorithm(optim.seed = 4567, n = 50, 
                                    pcrossover = 0.8, pmutation = 0.1, 
                                    maxiter = 3, elitism = 4, digits = c(2,3,3),
                                    sdi = TRUE, lr = c(0,1), 
                                    no.leaves = c(2,40), max.depth = c(1,10),
                                    min.data.in.leaf = c(2,1e7), 
                                    feature.fraction = c(0,1), cat.l2 = c(0,99),
                                    extra.trees = c(0,1), top.rate = c(0,0.5),
                                    other.rate = c(0,0.5), cat.smooth = c(0,99),
                                    path.smooth = c(0,99),
                                    inputdf = df_qx(di = "SDI", q = 1),
                                    y = full.df_7$PKV, est_type = "cross_entropy",
                                    alpha = 0.5, cv = 2L, no_trees = 100L,
                                    no_threads = 4L, early_stopping = 10)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

hyperpars_chronic<- genetic.algorithm(optim.seed = 4567, n = 50, 
                                    pcrossover = 0.8, pmutation = 0.1, 
                                    maxiter = 3, elitism = 4, digits = c(2,3,3),
                                    sdi = TRUE, lr = c(0,1), 
                                    no.leaves = c(2,40), max.depth = c(1,10),
                                    min.data.in.leaf = c(2,1e7), 
                                    feature.fraction = c(0,1), cat.l2 = c(0,99),
                                    extra.trees = c(0,1), top.rate = c(0,0.5),
                                    other.rate = c(0,0.5), cat.smooth = c(0,99),
                                    path.smooth = c(0,99),
                                    inputdf = df_qx(di = "SDI", q = 1),
                                    y = full.df_7$no_all_chronic_diseases, 
                                    est_type = "quantile", alpha = 0.5, cv = 2L,
                                    no_trees = 100L, no_threads = 4L, 
                                    early_stopping = 10L)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

model.list_1<- list(age = "quantile", gender = "cross_entropy", 
                    phi = "cross_entropy", chronic = "quantile")
model.list_2<- list(age = full.df_7$age, gender = full.df_7$female, 
                    phi = full.df_7$PKV, 
                    chronic = full.df_7$no_all_chronic_diseases)
x.list<- list(PraxisID = as.numeric(levels(as.factor(full.df_7$PraxisID))), 
              dow = seq(1,7), public_holiday = c(0, 1), 
              school_holiday = c(0, 1), week_of_month = seq(1, 5), 
              month = seq(1, 12), 
              year = seq(TG_DateNum2year(date.range[1]), 
                         TG_DateNum2year(date.range[2])),
              daylight_hours = seq(0.35, 0.65, by = 0.1), 
              covid_7_day_incidence = seq(0, 2500, length.out = 100))
x.list.factors<- list(PraxisID = NA, 
                      dow = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"), 
                      public_holiday = c("No", "Yes"), 
                      school_holiday = c("No", "Yes"), week_of_month = NA, 
                      month = NA, year = NA, daylight_hours = NA, 
                      covid_7_day_incidence = NA)
for(di in c("TDI", "HW", "SDI")){
  for(model.ind in seq_along(model.list_1)){
    if(model.list_1[[model.ind]] == "quantile"){
      hyp<- get(paste0("hyperpars_", names(model.list_1)[model.ind]))
      for(quant in c(".05", ".25", ".50", ".75", ".95")){
        model.name<- paste0("model_", names(model.list_1)[model.ind], quant, 
                            "_", di)
        assign(model.name, ga2model(hyp, inputdf = df_qx(di = di, q = 1),
                                    y = model.list_2[[model.ind]], 
                                    est.type = "quantile", 
                                    alpha = as.numeric(quant),
                                    no.trees = 100L, no.threads = 4L))
        perf.name<- paste0("perf.", names(model.list_1)[model.ind], quant, "_", 
                           di)
        assign(perf.name, ga2performance.eval(hyp, alpha = as.numeric(quant),
                                              inputdf = df_qx(di = di, q = 1),
                                              y = model.list_2[[model.ind]],
                                              est.type = "quantile"))
        if(di == "SDI"){
          processed.hyp<- unlist(hyp$best_in_class[,12:21])
          if(model.ind == 1){
            y.range<- 80
          }else{
            y.range<- 15
          }
          for(x.ind in seq_along(x.list)){
            model.eval(booster = get(model.name), DI = di, sdi = processed.hyp,
                       Q = 1, no.draws = 100, eval.var = names(x.list)[x.ind],
                       eval.seq = x.list[[x.ind]], seed = 8181818, 
                       y.max = y.range, y.name = names(model.list_1)[model.ind],
                       x.factor.names = x.list.factors[[x.ind]],
                       y.label = names(model.list_1)[model.ind])
          }
        }
      }
    }else{
      model.name<- paste0("model_", names(model.list_1)[model.ind], "_", di)
      hyp<- get(paste0("hyperpars_", names(model.list_1)[model.ind]))
      assign(model.name, ga2model(hyp, inputdf = df_qx(di = di, q = 1),
                                  y = model.list_2[[model.ind]],
                                  est.type = "cross_entropy", 
                                  alpha = as.numeric(quant), no.trees = 100L, 
                                  no.threads = 4L))
      perf.name<- paste0("perf.", names(model.list_1)[model.ind], "_", di)
      assign(perf.name, ga2performance.eval(hyp,
                                            inputdf = df_qx(di = di, q = 1),
                                            y = model.list_2[[model.ind]],
                                            est.type = "cross_entropy"))
      if(di == "SDI"){
          processed.hyp<- as.vector(as.matrix(hyp$best_in_class[,12:21]))
          for(x.ind in seq_along(x.list)){
            model.eval(booster = get(model.name), DI = di, sdi = processed.hyp,
                       Q = 1, no.draws = 100, eval.var = names(x.list)[x.ind],
                       eval.seq = x.list[[x.ind]], seed = 8181818, 
                       y.max = 1, y.name = names(model.list_1)[model.ind],
                       x.factor.names = x.list.factors[[x.ind]])
          }
        }
    }
  }
}
performance.plots("age", di = "SDI", practiceID = 6, galist = hyperpars_age,
                  y.name = "age", y.range = c(0, 80))
performance.plots("gender", di = "SDI", practiceID = 6, 
                  galist = hyperpars_gender, y.name = "proportion female", 
                  y.range = c(0, 1))
performance.plots("phi", di = "SDI", practiceID = 6, galist = hyperpars_phi,
                  y.name = "proportion privately insured", y.range = c(0, 1))
performance.plots("chronic", di = "SDI", practiceID = 6, hyperpars_chronic,
                  y.name = "number of chronic diseases", y.range = c(0, 20))

```
Research question 2:
```{r}
#Hyperparameter tuning
q2_SDI<- df_qx(di = "SDI", q = 2)
hyperpars_q2<- genetic.algorithm(optim.seed = 4567, n = 50, pcrossover = 0.8, 
                                 pmutation = 0.1, maxiter = 3, elitism = 4, 
                                 digits = c(2,3,3), sdi = TRUE, lr = c(0,1), 
                                 no.leaves = c(2,40), max.depth = c(1,10), 
                                 min.data.in.leaf = c(2,1e7), 
                                 feature.fraction = c(0,1), cat.l2 = c(0,99), 
                                 extra.trees = c(0,1), top.rate = c(0,0.5), 
                                 other.rate = c(0,0.5), cat.smooth = c(0,99), 
                                 path.smooth = c(0,99),
                                 inputdf = df_qx(di = "SDI", q = 2),
                                 y = train_diag_class, 
                                 est_type = "multiclass", cv = 2L, 
                                 no_trees = 100L, no_threads = 4L, 
                                 early_stopping = 10L)
if(make.saves) save.image(file = paste0("ws_", as.character(as.Date(Sys.time(), format = "%Y_%m_%d")), ".RData"))

model_q2_TDI<- ga2model(hyperpars_q2, inputdf = df_qx(di = "TDI", q = 2),
                     y = train_diag_class, est.type = "multiclass",
                     no.trees = 100L, no.threads = 4L)
model_q2_HW<- ga2model(hyperpars_q2, inputdf = df_qx(di = "TDI", q = 2),
                     y = train_diag_class, est.type = "multiclass",
                     no.trees = 100L, no.threads = 4L)
model_q2_SDI<- ga2model(hyperpars_q2, inputdf = df_qx(di = "TDI", q = 2),
                     y = train_diag_class, est.type = "multiclass",
                     no.trees = 100L, no.threads = 4L)

# performance eval
perf.q2_TDI<- ga2performance.eval(hyperpars_q2, 
                                  inputdf = df_qx(di = "TDI", q = 2),
                                  y = train_diag_class, 
                                  est.type = "multiclass", 
                                  cv = 10)
rq2.performance.plot(model_q2_TDI, di = "TDI", no.draws = 5000, seed = 1261)
perf.q2_HW<- ga2performance.eval(hyperpars_q2, 
                                 inputdf = df_qx(di = "HW", q = 2),
                                 y = train_diag_class, 
                                 est.type = "multiclass",
                                 cv = 10)
rq2.performance.plot(model_q2_HW, di = "HW", no.draws = 5000, seed = 1261)
perf.q2_SDI<- ga2performance.eval(hyperpars_q2, 
                                  inputdf = df_qx(di = "SDI", q = 2),
                                  y = train_diag_class, 
                                  est.type = "multiclass",
                                  cv = 10)
rq2.performance.plot(model_q2_SDI, di = "SDI", no.draws = 5000, seed = 1261)

# eval of output
x.list<- list(PraxisID = as.numeric(levels(as.factor(full.df_7$PraxisID))), 
              dow = seq(1,7), public_holiday = c(0, 1), 
              school_holiday = c(0, 1), week_of_month = seq(1, 5), 
              month = seq(1, 12), 
              year = seq(TG_DateNum2year(date.range[1]), 
                         TG_DateNum2year(date.range[2])),
              daylight_hours = seq(0.35, 0.65, by = 0.1), 
              covid_7_day_incidence = seq(0, 2500, length.out = 100), 
              age = seq(18, 70), female = c(0, 1), PKV = c(0, 1), 
              smoking = c(0, 1), alcohol = c(0, 1), sport = c(0, 1), 
              chronic_1 = seq(0, 10), chronic_2 = seq(0, 10), 
              chronic_3 = seq(0, 10), chronic_4 = seq(0, 10), 
              chronic_5 = seq(0, 10), chronic_6 = seq(0, 10), 
              chronic_7 = seq(0, 10), chronic_8 = seq(0, 10), 
              chronic_9 = seq(0, 10), chronic_10 = seq(0, 10), 
              chronic_11 = seq(0, 10), no_all_chronic_diseases = seq(0, 20),
              last_visit = seq(1, 56)
              )
x.list.factors<- list(PraxisID = NA, 
                      dow = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"), 
                      public_holiday = c("No", "Yes"), 
                      school_holiday = c("No", "Yes"), week_of_month = NA, 
                      month = NA, year = NA, daylight_hours = NA, 
                      covid_7_day_incidence = NA, age = NA, 
                      female = c("male", "female"), 
                      PKV = c("statutory", "private"), smoking = c("No", "Yes"), 
                      alcohol = c("No", "Yes"), sport = c("No", "Yes"), 
                      chronic_1 = NA, chronic_2 = NA, chronic_3 = NA, 
                      chronic_4 = NA, chronic_5 = NA, chronic_6 = NA, 
                      chronic_7 = NA, chronic_8 = NA, chronic_9 = NA, 
                      chronic_10 = NA, chronic_11 = NA, 
                      no_all_chronic_diseases = NA, last_visit = NA
              )
sel.seed<- 7518269
model.eval(booster = model_q2_TDI, DI = "TDI", Q = 2, no.draws = 100, 
           eval.var = "thoms_discomfort_index", 
           eval.seq = seq(min(full.df_7$thoms_discomfort_index), 
                          max(full.df_7$thoms_discomfort_index), 
                          length.out = 500), 
           seed = sel.seed, y.max = 1)

model.eval(booster = model_q2_HW, DI = "HW", Q = 2, no.draws = 100, 
           eval.var = "length_heatwave", 
           eval.seq = seq(min(full.df_7$length_heatwave), 
                          max(full.df_7$length_heatwave)), 
           seed = sel.seed, y.max = 1)

sdi_q2<- as.vector(as.matrix(hyperpars_q2$best_in_class[,12:21]))
full.df_7$sdi_q2<- SDI(df = full.df_7, 
                       w = dbetabinom.ab(x = seq(0, sdi_q2[1]), 
                                         size = sdi_q2[1], shape1 = sdi_q2[2], 
                                         shape2 = sdi_q2[3]),
                       theta = sdi_q2[4:6], rho = sdi_q2[7:9], tau = sdi_q2[10])
sdi_q2_range<- range(full.df_7$sdi_q2)
model.eval(booster = model_q2_SDI, DI = "SDI", sdi = sdi_q2, Q = 2, 
           no.draws = 100, eval.var = "sdi", 
           eval.seq = seq(sdi_q2_range[1], sdi_q2_range[2], length.out = 500), 
           seed = sel.seed, y.max = 1)

for(x.ind in seq_along(x.list)){
    model.eval(booster = model_q2_SDI, DI = "SDI", sdi = sdi_q2, Q = 2, 
               no.draws = 100, eval.var = names(x.list)[x.ind], 
               eval.seq = x.list[[x.ind]], seed = sel.seed, y.max = 1, 
               x.factor.names = x.list.factors[[x.ind]])
}

```

