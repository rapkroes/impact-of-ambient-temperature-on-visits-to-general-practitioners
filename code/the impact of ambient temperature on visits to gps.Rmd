---
title: "Impact of Ambient Temperature on Visits to General Practitioners"
author: "Raphael Kroes"
date: "2023-12-02"
output: html_document
---

This is the main Markdown file for the data analysis of 'Impact of Ambient Temperature on Visits to General Practitioners' by Raphael Kroes.
The original data cannot be provided publicly because of data protection reasons. However, a fake dataset is provided, which can be used to test the code.
```{r}
library(devtools)
library(readxl)
library(lubridate)
library(dplyr)
library(parallel)
```
```{r}


#read file with functions
source("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/code/functions_mt.R")

#read auxiliary data files
ListeKrankenkassen<- read.csv("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/other%20data/ListeKrankenkassen_up.csv")
classification.matrix<- read.csv("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/other%20data/classification.csv")
icd10_blocks<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/icd10_blocks.csv")
holidays<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/numeric_holidays.csv")

fake.data<- TRUE
if(fake.data){
  source_url("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/code/fakedgp_mt.R")
}else{
  #read in other data
}

#date range
date.range<- range(Diag3$TG_DateNum)

#location data
location_information<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/location%20information.csv", header = TRUE, encoding = "Latin-1")
location.name<- location_information$location.name

#weather data
for(i in seq_along(location.name)){
  url_string<- paste0("https://raw.githubusercontent.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/main/weather%20data/wetter%20",location.name[i],".csv")
  im<- read.csv(url_string)
  colnames(im)<- c("time", "temperature_celsius", "relative_humidity", "dew_point", "apparent_temperature_celsius", "precipitation", "rain", "snow_fall", "snow_depth", "surface_pressure")

  #unit transformations
  im$TG_DateNum<- date2TG_DateNum(im$time)
  im<- im|>
    filter(TG_DateNum>=date.range[1]-21 & TG_DateNum<=date.range[2])
  im$temperature_kelvin<- im$temperature_celsius +273.16
  
  assign(paste0("wetter_",location.name[i]),im)
  weatherdata.transformation(im,sel.quantile = .95, loc = location.name[i], dr = date.range)
}



#daylight data
for(i in seq_along(location.name)){
  url_string<- paste0("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/daylight%20hours%20data/daylight_",location.name[i],".csv")
  im<- read.csv(url_string, header = TRUE)
  
  #unit transformations
  #im$TG_DateNum<- date2TG_DateNum(im$time)
  im<- im|>
    filter(TG_DateNum>=date.range[1] & TG_DateNum<=date.range[2])
  assign(paste0("daylight_",location.name[i]),im)
}

#Covid-19 data
covid.data<- read.csv("https://github.com/rapkroes/impact-of-ambient-temperature-on-visits-to-general-practitioners/raw/main/other%20data/COVID-19-Faelle_7-Tage-Inzidenz_Landkreise.csv")







```
We must check Diag's icd10 column: Since the icd10 field is a text field in the GP's software, the data might contain typing errors or atypical notation of diseases. This function returns a vector that filters out whose entries are =1 if they are 'suspicious' and 0 otherwise. An entry is considered suspicious if it does not have a length of 4, 6, or 7 characters. If it has 4, 6, or 7 characters it is suspicious if it does not follow either of the patterns "capital letter, two numbers, capital letter" or "capital letter, two numbers, fullstop, one or two numbers, capital letter".
```{r}
View(Diag3[as.logical(suspicious.Diag.entries(Diag3$icd10)),])
```

Stamm and Konsul must be merged to Diag, and the resulting data frame must be cleared.
```{r}
### chronic diseases
chronic.sel<- grepl("DD",Diag3$DiagTyp)
chronic.df<- as.data.frame(cbind(Diag3$uniPatID,Diag3$icd10)[chronic.sel,])|>
  distinct()
colnames(chronic.df)<- c("uniPatID", "diag_category")
chronic.df$diag_category<- icd10.to.class(chronic.df$diag_category)
full.df_1<- add.chronic(Diag3[!chronic.sel,], chronic.df)


### stamm data
full.df_1<- add.stamm.new.par(Diag3,Stamm3,no.splits = 50, no.workers = 2)
# gender variable
gender.selector<- full.df_1$Weibl==1 | full.df_1$Maennl==1 | full.df_1$stamm.is.there==0
full.df_1$female<- full.df_1$Weibl
full.df_1.2<- full.df_1[gender.selector,]|>
  select(-Weibl,-Maennl,-Transgen,-Divers,-Geschlundef)
#add PKV (private health insurance) dummy
full.df_1.2$PKV<- IK2PKV(full.df_1$IK)

### konsul
full.df_2<- add.konsul(full.df_1.2, Konsul3, no.splits = 50, no.workers = 2)

### time
full.df_3<- full.df_2
full.df_3$dow<- as.factor(TG_DateNum2dow(full.df_3$TG_DateNum))
full.df_3<- cbind(full.df_3,TG_DateNum2holiday(full.df_3$TG_DateNum))
full.df_3$week<- as.factor(TG_DateNum2week(full.df_3$TG_DateNum))
full.df_3$month<- as.factor(TG_DateNum2month(full.df_3$TG_DateNum))
full.df_3$year<- as.factor(TG_DateNum2year(full.df_3$TG_DateNum))
full.df_3$age<- TG_DateNum2year(full.df_3$TG_DateNum)-full.df_3$Geburtsjahr

### covid-19
full.df_4<- full.df_3
full.df_4$landkreis_id<- praxis_id2landkreis_id(full.df_4$PraxisID)


```

```{r}
location.name<- c("aalen","ammerbuch","baiersbronn","boeblingen","boennigheim","pforzheim","pleidelsheim","salach","schluchsee","schopfheim","schwaebisch gmuend","waldachtal","wendlingen")
latitude<- c(48.8,48.6,48.5,48.7,49,48.9,49,48.7,47.8,47.7,48.8,48.5,48.7)
longitude<- c(10.1,9,8.4,9,9.1,8.7,9.2,9.7,8.2,7.8,9.8,8.6,9.4)
write.csv(cbind(location.name,latitude,longitude),"location information.csv")
getwd()
```


